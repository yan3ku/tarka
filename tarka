#!/bin/sh
#
#
# set -xe

parse() {
    rest="$(basename "$1")"
    # shellcheck disable=SC2034
    psrc="$(echo "~${rest%~*}~" | tr '~' '/')"
    rest="${1##*~}"
    # shellcheck disable=SC2034
    pdate="${rest%=*}"
    rest="${rest##*=}"
    # shellcheck disable=SC2034
    phash="${rest%!*}"
    rest="${rest##*!}"
    # shellcheck disable=SC2034
    pnr="${rest%--*}"
    pnr="${rest%.*}"
    rest="${rest##*--}"
    # shellcheck disable=SC2034
    ptag="${rest}"

    # echo "psrc $psrc"
    # echo "date $pdate"
    # echo "hash $phash"
    # echo "pnr $pnr"
}

latest() {
    latest=""
    for i in "$repo"/"$1"*; do
        [ "${i##*.}" != snar ] && latest="$i"
    done
}

untar() {
    for i in "$repo"/"$1"*"$2"*.tar; do
        echo "untaring $i..."
        tar xf "$i" -C "$repo/" -G
    done
}

mangle_path() {
    p="${1%/}"
    p="$(echo "${p#/}" | tr '/' '~')"
}

setsrc() {
    src=$(realpath "$1")
    mangle_path "$src"
    src_mangled="$p"
}

# setargs REPO SRC [TAG]
setargs() {
    setsrc "$1"
    tag=${2:-}
    date=$(date +'%Y-%m-%d__%H-%M.%S')
    latest "$src_mangled"

    if [ -n "$isfull" ] || [ ! -e "$latest" ]; then
        isfull=1
        hash="$(date +%s | md5sum | head -c 8)"
        nr="0"
    else
        parse "$latest"
        hash="$phash"
        nr="$((pnr+1))"
    fi

    group="${repo}/${src_mangled}~${hash}"
    dst="${repo}/${src_mangled}~${date}=${hash}!${nr}${tag:+--}${tag}"
}

list() {
    mangle_path "$1"
    printf "%-40s %-30s %s\n" "src" "date" "nr"
    for i in "$repo/"${p}*.tar; do
        parse "$i"
        printf "%-40s %-30s %s\n" "$psrc" "$pdate" "$pnr"
    done
}

sync() {
    # exit 0
    rsync -avz --delete \
          "${1}/" \
          "${2}"
    # --exclude-from="$0-ignore" \
}

roll() {
    tar cvf "${2}.tar" "${1}" -g "${1}.snar" --xform="s|^${repo}/||"
}

usage() {
    echo "$0 cmd repo cmd_args"
    exit 1
}

main() {
    test -n "$1" || usage
    test -n "$2" || usage

    cmd="$1"
    shift
    repo=${1%/}
    case "$cmd" in
        f*)  isfull=1 && shift && break;;
        i*)  isinc=1  && shift && break;;
        l*)  isls=1   && list "$@" && exit;;
        *) echo "invalid operation: $cmd;" >&2
           exit 1;;
    esac

    setargs "$1" "$2"
    # [ -z "$isfull" ] && untar "$src_mangled" "$hash"

    printf "%-15s : %s\n" "group" "$group"
    printf "%-15s : %s\n" "latest" "$latest"
    printf "%-15s : %s\n" "destination" "$dst"
    echo "----------"

    sync "$src" "$group"
    roll "$group" "$dst"
    rm -rf "${group}"
}

main "$@"
